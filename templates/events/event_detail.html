{% extends 'base.html' %}
{% load static %}
{% load event_filters %}

{% block title %}Detalle del Evento - Sistema de Trazabilidad{% endblock %}
{% block description %}Información detallada del evento registrado en el sistema de trazabilidad agrícola.{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'event_list' %}">Eventos</a></li>
            <li class="breadcrumb-item active">Detalle</li>
        </ol>
    </nav>

    <!-- Header con tipo de evento -->
    <div class="mb-4">
        <div class="d-flex align-items-center gap-3">
            <div class="p-3 rounded-3" style="background-color: {{ event.event_type.color }}20;">
                <i class="bi bi-{{ event.event_type.icon }} display-6" 
                   style="color: {{ event.event_type.color }};"></i>
            </div>
            <div>
                <h2 class="mb-1">{{ event.event_type.name }}</h2>
                <p class="text-muted mb-0">
                    <i class="bi bi-calendar3"></i> {{ event.timestamp|date:"d/m/Y H:i" }}
                    <span class="mx-2">|</span>
                    <i class="bi bi-person-fill"></i> {{ event.created_by.get_full_name|default:event.created_by.username }}
                </p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna principal -->
        <div class="col-lg-8">
            <!-- Información Básica -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle text-success"></i> Información Básica
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted small mb-1">CAMPO</h6>
                            <p class="mb-0">
                                <strong>{{ event.field.name }}</strong>
                                <span class="text-muted">({{ event.field.code }})</span>
                            </p>
                            {% if event.field.location %}
                            <small class="text-muted">{{ event.field.location }}</small>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted small mb-1">CAMPAÑA</h6>
                            <p class="mb-0">
                                {% if event.campaign %}
                                    <strong>{{ event.campaign.name }}</strong>
                                    <span class="badge bg-info">{{ event.campaign.season }}</span>
                                {% else %}
                                    <span class="text-muted fst-italic">Sin campaña asignada</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted small mb-1">CATEGORÍA</h6>
                            <span class="badge bg-secondary">{{ event.event_type.get_category_display }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted small mb-1">FECHA DE REGISTRO</h6>
                            <p class="mb-0">{{ event.created_at|date:"d/m/Y H:i" }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datos Específicos del Evento -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list-task text-success"></i> Datos del Evento
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <tbody>
                                {% if event.event_type.name == 'Aplicación de Riego' %}
                                    <tr><th class="text-muted" style="width: 40%;">Método de Riego</th><td>{{ event.metodo }}</td></tr>
                                    <tr><th class="text-muted">Duración (minutos)</th><td>{{ event.duracion_minutos }}</td></tr>
                                    <tr><th class="text-muted">Fuente de Agua</th><td>{{ event.fuente_agua }}</td></tr>
                                    {% if event.volumen_m3 %}<tr><th class="text-muted">Volumen (m³)</th><td>{{ event.volumen_m3 }}</td></tr>{% endif %}
                                    {% if event.presion_bar %}<tr><th class="text-muted">Presión (bar)</th><td>{{ event.presion_bar }}</td></tr>{% endif %}
                                    {% if event.ce_uScm %}<tr><th class="text-muted">CE (µS/cm)</th><td>{{ event.ce_uScm }}</td></tr>{% endif %}
                                    {% if event.ph %}<tr><th class="text-muted">pH</th><td>{{ event.ph }}</td></tr>{% endif %}
                                
                                {% elif event.event_type.name == 'Aplicación de Fertilizante' %}
                                    <tr><th class="text-muted">Producto</th><td>{{ event.producto }}</td></tr>
                                    <tr><th class="text-muted">Método de Aplicación</th><td>{{ event.metodo_aplicacion }}</td></tr>
                                    <tr><th class="text-muted">Dosis</th><td>{{ event.dosis }} {{ event.unidad_dosis }}</td></tr>
                                    {% if event.n_porcentaje %}<tr><th class="text-muted">Nitrógeno (%)</th><td>{{ event.n_porcentaje }}</td></tr>{% endif %}
                                    {% if event.p_porcentaje %}<tr><th class="text-muted">Fósforo (%)</th><td>{{ event.p_porcentaje }}</td></tr>{% endif %}
                                    {% if event.k_porcentaje %}<tr><th class="text-muted">Potasio (%)</th><td>{{ event.k_porcentaje }}</td></tr>{% endif %}
                                    {% if event.volumen_caldo_l %}<tr><th class="text-muted">Volumen de Caldo (L)</th><td>{{ event.volumen_caldo_l }}</td></tr>{% endif %}
                                
                                {% elif event.event_type.name == 'Aplicación Fitosanitaria' %}
                                    <tr><th class="text-muted">Producto</th><td>{{ event.producto }}</td></tr>
                                    {% if event.ingrediente_activo %}<tr><th class="text-muted">Ingrediente Activo</th><td>{{ event.ingrediente_activo }}</td></tr>{% endif %}
                                    <tr><th class="text-muted">Tipo de Producto</th><td>{{ event.tipo_producto }}</td></tr>
                                    <tr><th class="text-muted">Objetivo</th><td>{{ event.objetivo }}</td></tr>
                                    <tr><th class="text-muted">Método de Aplicación</th><td>{{ event.metodo_aplicacion }}</td></tr>
                                    <tr><th class="text-muted">Dosis</th><td>{{ event.dosis }} {{ event.unidad_dosis }}</td></tr>
                                    {% if event.lote_producto %}<tr><th class="text-muted">Lote del Producto</th><td>{{ event.lote_producto }}</td></tr>{% endif %}
                                    {% if event.volumen_caldo_l %}<tr><th class="text-muted">Volumen de Caldo (L)</th><td>{{ event.volumen_caldo_l }}</td></tr>{% endif %}
                                    {% if event.presion_bar %}<tr><th class="text-muted">Presión (bar)</th><td>{{ event.presion_bar }}</td></tr>{% endif %}
                                    {% if event.intervalo_seguridad_dias %}<tr><th class="text-muted">Intervalo de Seguridad (días)</th><td>{{ event.intervalo_seguridad_dias }}</td></tr>{% endif %}
                                    {% if event.responsable_aplicacion %}<tr><th class="text-muted">Responsable</th><td>{{ event.responsable_aplicacion }}</td></tr>{% endif %}
                                    {% if event.eficacia_observada %}<tr><th class="text-muted">Eficacia Observada</th><td>{{ event.eficacia_observada }}</td></tr>{% endif %}
                                    <tr><th class="text-muted">Fitotoxicidad</th><td>{% if event.fitotoxicidad %}<i class="bi bi-check-circle-fill text-success"></i> Sí{% else %}<i class="bi bi-x-circle-fill text-danger"></i> No{% endif %}</td></tr>
                                
                                {% elif event.event_type.name == 'Labores de Cultivo' %}
                                    <tr><th class="text-muted">Actividad</th><td>{{ event.actividad }}</td></tr>
                                    <tr><th class="text-muted">Horas-Hombre</th><td>{{ event.horas_hombre }}</td></tr>
                                    {% if event.herramienta_equipo %}<tr><th class="text-muted">Herramienta/Equipo</th><td>{{ event.herramienta_equipo }}</td></tr>{% endif %}
                                    {% if event.numero_jornales %}<tr><th class="text-muted">Número de Jornales</th><td>{{ event.numero_jornales }}</td></tr>{% endif %}
                                    {% if event.objetivo %}<tr><th class="text-muted">Objetivo</th><td>{{ event.objetivo }}</td></tr>{% endif %}
                                    {% if event.porcentaje_completado %}<tr><th class="text-muted">Porcentaje Completado</th><td>{{ event.porcentaje_completado }}%</td></tr>{% endif %}
                                    {% if event.herramientas_desinfectadas is not None %}<tr><th class="text-muted">Herramientas Desinfectadas</th><td>{% if event.herramientas_desinfectadas %}<i class="bi bi-check-circle-fill text-success"></i> Sí{% else %}<i class="bi bi-x-circle-fill text-danger"></i> No{% endif %}</td></tr>{% endif %}
                                
                                {% elif event.event_type.name == 'Monitoreo de Plagas' %}
                                    <tr><th class="text-muted">Plaga/Enfermedad</th><td>{{ event.plaga_enfermedad }}</td></tr>
                                    <tr><th class="text-muted">Método de Muestreo</th><td>{{ event.metodo_muestreo }}</td></tr>
                                    <tr><th class="text-muted">Incidencia</th><td>{{ event.incidencia }}</td></tr>
                                    {% if event.severidad %}<tr><th class="text-muted">Severidad</th><td>{{ event.severidad }}</td></tr>{% endif %}
                                    {% if event.ubicacion_campo %}<tr><th class="text-muted">Ubicación en el Campo</th><td>{{ event.ubicacion_campo }}</td></tr>{% endif %}
                                    {% if event.numero_muestras %}<tr><th class="text-muted">Número de Muestras</th><td>{{ event.numero_muestras }}</td></tr>{% endif %}
                                    {% if event.accion_recomendada %}<tr><th class="text-muted">Acción Recomendada</th><td>{{ event.accion_recomendada }}</td></tr>{% endif %}
                                
                                {% elif event.event_type.name == 'Brote de Plaga/Enfermedad' %}
                                    <tr><th class="text-muted">Tipo de Problema</th><td>{{ event.tipo_problema }}</td></tr>
                                    <tr><th class="text-muted">Severidad</th><td>{{ event.severidad }}</td></tr>
                                    <tr><th class="text-muted">Método de Detección</th><td>{{ event.metodo_deteccion }}</td></tr>
                                    {% if event.area_afectada_ha %}<tr><th class="text-muted">Área Afectada (ha)</th><td>{{ event.area_afectada_ha }}</td></tr>{% endif %}
                                    {% if event.porcentaje_afectacion %}<tr><th class="text-muted">Porcentaje de Afectación</th><td>{{ event.porcentaje_afectacion }}%</td></tr>{% endif %}
                                    <tr><th class="text-muted">Requiere Tratamiento</th><td>{% if event.requiere_tratamiento %}<i class="bi bi-check-circle-fill text-success"></i> Sí{% else %}<i class="bi bi-x-circle-fill text-danger"></i> No{% endif %}</td></tr>
                                    {% if event.accion_inmediata %}<tr><th class="text-muted">Acción Inmediata</th><td>{{ event.accion_inmediata }}</td></tr>{% endif %}
                                
                                {% elif event.event_type.name == 'Condiciones Climáticas' %}
                                    <tr><th class="text-muted">Temperatura Máxima</th><td>{{ event.temperatura_max }} °C</td></tr>
                                    <tr><th class="text-muted">Temperatura Mínima</th><td>{{ event.temperatura_min }} °C</td></tr>
                                    {% if event.humedad_relativa %}<tr><th class="text-muted">Humedad Relativa</th><td>{{ event.humedad_relativa }}%</td></tr>{% endif %}
                                    {% if event.precipitacion_mm %}<tr><th class="text-muted">Precipitación</th><td>{{ event.precipitacion_mm }} mm</td></tr>{% endif %}
                                    {% if event.velocidad_viento_ms %}<tr><th class="text-muted">Velocidad del Viento</th><td>{{ event.velocidad_viento_ms }} m/s</td></tr>{% endif %}
                                    {% if event.viento %}<tr><th class="text-muted">Condición de Viento</th><td>{{ event.viento }}</td></tr>{% endif %}
                                    {% if event.radiacion_solar_wm2 %}<tr><th class="text-muted">Radiación Solar</th><td>{{ event.radiacion_solar_wm2 }} W/m²</td></tr>{% endif %}
                                
                                {% elif event.event_type.name == 'Cosecha' %}
                                    {% if event.variedad %}<tr><th class="text-muted">Variedad</th><td>{{ event.variedad }}</td></tr>{% endif %}
                                    <tr><th class="text-muted">Volumen Total</th><td>{{ event.volumen_kg }} kg</td></tr>
                                    <tr><th class="text-muted">Rendimiento</th><td>{{ event.rendimiento_kg_ha }} kg/ha</td></tr>
                                    {% if event.calidad %}<tr><th class="text-muted">Calidad</th><td>{{ event.get_calidad_display }}</td></tr>{% endif %}
                                    {% if event.numero_trabajadores %}<tr><th class="text-muted">Número de Trabajadores</th><td>{{ event.numero_trabajadores }}</td></tr>{% endif %}
                                    {% if event.horas_trabajo %}<tr><th class="text-muted">Horas de Trabajo</th><td>{{ event.horas_trabajo }}</td></tr>{% endif %}
                                    {% if event.fecha_inicio %}<tr><th class="text-muted">Fecha Inicio</th><td>{{ event.fecha_inicio|date:"d/m/Y" }}</td></tr>{% endif %}
                                    {% if event.fecha_fin %}<tr><th class="text-muted">Fecha Fin</th><td>{{ event.fecha_fin|date:"d/m/Y" }}</td></tr>{% endif %}
                                
                                {% elif event.event_type.name == 'Almacenamiento Poscosecha' %}
                                    <tr><th class="text-muted">Producto</th><td>{{ event.producto }}</td></tr>
                                    <tr><th class="text-muted">Cantidad</th><td>{{ event.cantidad_kg }} kg</td></tr>
                                    <tr><th class="text-muted">Temperatura</th><td>{{ event.temperatura }} °C</td></tr>
                                    <tr><th class="text-muted">Humedad</th><td>{{ event.humedad }}%</td></tr>
                                    {% if event.tipo_almacenamiento %}<tr><th class="text-muted">Tipo de Almacenamiento</th><td>{{ event.tipo_almacenamiento }}</td></tr>{% endif %}
                                    {% if event.fecha_ingreso %}<tr><th class="text-muted">Fecha de Ingreso</th><td>{{ event.fecha_ingreso|date:"d/m/Y" }}</td></tr>{% endif %}
                                    {% if event.fecha_salida_prevista %}<tr><th class="text-muted">Fecha de Salida Prevista</th><td>{{ event.fecha_salida_prevista|date:"d/m/Y" }}</td></tr>{% endif %}
                                    {% if event.condiciones_observadas %}<tr><th class="text-muted">Condiciones Observadas</th><td>{{ event.condiciones_observadas }}</td></tr>{% endif %}
                                
                                {% elif event.event_type.name == 'Mano de Obra y Costos' %}
                                    <tr><th class="text-muted">Actividad</th><td>{{ event.actividad }}</td></tr>
                                    <tr><th class="text-muted">Número de Trabajadores</th><td>{{ event.numero_trabajadores }}</td></tr>
                                    {% if event.horas_trabajo %}<tr><th class="text-muted">Horas de Trabajo</th><td>{{ event.horas_trabajo }}</td></tr>{% endif %}
                                    {% if event.costo_hora %}<tr><th class="text-muted">Costo por Hora</th><td>${{ event.costo_hora }}</td></tr>{% endif %}
                                    <tr><th class="text-muted">Costo Total</th><td><strong>${{ event.costo_total }}</strong></td></tr>
                                
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Observaciones -->
            {% if event.observations %}
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-left-text text-success"></i> Observaciones
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-0" style="white-space: pre-wrap;">{{ event.observations }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Archivos Adjuntos -->
            {% if attachments %}
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-paperclip text-success"></i> Archivos Adjuntos
                        <span class="badge bg-success ms-2">{{ attachments|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for attachment in attachments %}
                        <div class="list-group-item px-0">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    {% if attachment.mime_type|slice:":5" == "image" %}
                                        <i class="bi bi-file-earmark-image text-primary" style="font-size: 1.5rem;"></i>
                                    {% elif attachment.mime_type == "application/pdf" %}
                                        <i class="bi bi-file-earmark-pdf text-danger" style="font-size: 1.5rem;"></i>
                                    {% elif "spreadsheet" in attachment.mime_type or "excel" in attachment.mime_type or attachment.file_name|slice:"-4:" == ".xls" or attachment.file_name|slice:"-5:" == ".xlsx" %}
                                        <i class="bi bi-file-earmark-excel text-success" style="font-size: 1.5rem;"></i>
                                    {% elif "word" in attachment.mime_type or attachment.file_name|slice:"-4:" == ".doc" or attachment.file_name|slice:"-5:" == ".docx" %}
                                        <i class="bi bi-file-earmark-word text-primary" style="font-size: 1.5rem;"></i>
                                    {% elif attachment.file_name|slice:"-4:" == ".csv" %}
                                        <i class="bi bi-file-earmark-spreadsheet text-info" style="font-size: 1.5rem;"></i>
                                    {% else %}
                                        <i class="bi bi-file-earmark text-secondary" style="font-size: 1.5rem;"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ attachment.file_name }}</h6>
                                    <p class="small text-muted mb-2">
                                        <i class="bi bi-hdd"></i> {{ attachment.file_size|filesizeformat }}
                                        <span class="mx-1">•</span>
                                        <i class="bi bi-calendar3"></i> {{ attachment.uploaded_at|date:"d/m/Y H:i" }}
                                        <span class="mx-1">•</span>
                                        <i class="bi bi-person"></i> {{ attachment.uploaded_by.get_full_name|default:attachment.uploaded_by.username }}
                                    </p>
                                    <a href="{{ attachment.file.url }}" 
                                       class="btn btn-sm btn-outline-primary" 
                                       target="_blank"
                                       download>
                                        <i class="bi bi-download"></i> Descargar
                                    </a>
                                    {% if attachment.mime_type|slice:":5" == "image" %}
                                        <a href="{{ attachment.file.url }}" 
                                           class="btn btn-sm btn-outline-secondary" 
                                           target="_blank">
                                            <i class="bi bi-eye"></i> Ver
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Acciones Rápidas -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0">Acciones</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'event_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left"></i> Volver a la lista
                        </a>
                    </div>
                </div>
            </div>

            <!-- Detalles del Campo -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-geo-alt-fill text-success"></i> Detalles del Campo
                    </h6>
                </div>
                <div class="card-body">
                    <dl class="mb-0">
                        <dt class="small text-muted">Nombre</dt>
                        <dd>{{ event.field.name }}</dd>
                        
                        <dt class="small text-muted">Código</dt>
                        <dd><code>{{ event.field.code }}</code></dd>
                        
                        {% if event.field.location %}
                        <dt class="small text-muted">Ubicación</dt>
                            <dd>{{ event.field.location }}</dd>
                        {% endif %}
                        
                        {% if event.field.surface_ha %}
                        <dt class="small text-muted">Superficie</dt>
                            <dd>{{ event.field.surface_ha }} ha</dd>
                            {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Detalles de la Campaña -->
            {% if event.campaign %}
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-calendar-check text-success"></i> Detalles de la Campaña
                    </h6>
                </div>
                <div class="card-body">
                    <dl class="mb-0">
                        <dt class="small text-muted">Campaña</dt>
                        <dd>{{ event.campaign.name }}</dd>
                        
                        <dt class="small text-muted">Temporada</dt>
                        <dd><span class="badge bg-info">{{ event.campaign.season }}</span></dd>
                        
                        {% if event.campaign.variety %}
                            <dt class="small text-muted">Variedad</dt>
                            <dd>{{ event.campaign.variety }}</dd>
                        {% endif %}
                        
                        <dt class="small text-muted">Periodo</dt>
                        <dd>
                            {{ event.campaign.start_date|date:"d/m/Y" }} - 
                            {% if event.campaign.end_date %}
                                {{ event.campaign.end_date|date:"d/m/Y" }}
                            {% else %}
                                <span class="badge bg-success">Activa</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
            {% endif %}

            <!-- Metadatos -->
            <div class="card">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-info-square"></i> Metadatos
                    </h6>
                </div>
                <div class="card-body">
                    <dl class="mb-0 small">
                        <dt class="text-muted">ID del Evento</dt>
                        <dd><code class="small">{{ event.id }}</code></dd>
                        
                        <dt class="text-muted">Creado por</dt>
                        <dd>{{ event.created_by.get_full_name|default:event.created_by.username }}</dd>
                        
                        <dt class="text-muted">Fecha de creación</dt>
                        <dd>{{ event.created_at|date:"d/m/Y H:i:s" }}</dd>
                        
                        <dt class="text-muted">Última modificación</dt>
                        <dd>{{ event.updated_at|date:"d/m/Y H:i:s" }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
